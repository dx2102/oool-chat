<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OoolChat</title>

  <!-- <script src="https://cdn.tailwindcss.com"></script> -->
  <!-- <script type="module" src="https://cdn.skypack.dev/twind/shim"></script> -->
  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>
  <script type="module">
    // Tailwind CDN has a 300 second cache max-age which is too short
    // most other CDNs allow 1 year of caching
    // we cache tailwind manually in localStorage
    // this block should appear before any other type="module" imports to prevent blocking and FOUC
    // let tailwindCode = localStorage.getItem('cdn-cache-tailwind');
    // if (!tailwindCode) {
    //   tailwindCode = await(await fetch('https://cdn.tailwindcss.com/3.4.17')).text();
    //   localStorage.setItem('cdn-cache-tailwind', tailwindCode);
    // }
    // const elm = document.createElement('script');
    // elm.text = tailwindCode;
    // document.head.appendChild(elm);
  </script>

  <!-- <script type="module" src="https://cdn.skypack.dev/openai@6.9.1"></script> -->

  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.8.1/github-markdown.min.css"> -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath@1.0.0/texmath.min.js"></script>

  <!-- <link rel="icon" href="
    data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
        <rect width='100' height='100' fill='%23dbeafe'/>
        <text x='50' y='72' text-anchor='middle' font-family='ui-sans-serif' font-size='65' fill='black'>Z</text>
    </svg>
  "> -->
  <link rel="icon" href="data:image/svg+xml,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
      <text x='0%' y='50%' style='text-anchor:center;dominant-baseline:central;font-size:100px;'>‚úèÔ∏è</text>
    </svg>
  ">

  <style>
    input:focus,
    textarea:focus {
      outline: none;
      box-shadow: none;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* .prose means markdown blocks */

    .prose p,
    .prose pre,
    .prose ul,
    .prose ol {
      margin-bottom: 0.5em;
    }

    .prose pre {
      overflow-x: auto;
      padding: 1em;
      /* bg-gray-100 */
      background-color: oklch(98.5% 0.002 247.839);
      border-radius: 0.5em;
    }

    .prose code {
      /* p-1, bg-gray-50, rounded-lg  */
      overflow-x: scroll;
      padding: 0.25em;
      background-color: oklch(96.7% 0.003 264.542);
      border-radius: 0.5em;
    }

    .prose pre code {
      padding: 0;
      background: transparent;
      border-radius: 0;
    }

    .prose ul {
      list-style-type: disc;
      margin-left: 1.5em;
    }

    .prose ol {
      list-style-type: decimal;
      margin-left: 1.5em;
    }

    .prose hr {
      margin: 2em 0;
      /* border-t border-gray-200 */
      border-top: 1px solid oklch(90% 0.01 240);
    }

    .katex-display {
      overflow-x: auto;
      overflow-y: hidden;
    }

    /* copy button */
    .copy-btn {
      transition: opacity 0.05s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }

    pre:hover>.copy-btn {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>

<body class="flex h-dvh bg-white font-sans touch-manipulation">

  <aside class="text-base w-72 flex-shrink-0 pt-2 bg-gray-50 border-r border-gray-200 overflow-hidden flex flex-col">
    <div class="px-2">
      <button id="newChatBtn" class="w-full py-2 px-3 rounded-lg bg-gray-50 hover:bg-gray-200 flex">
        ‚úèÔ∏è New Chat
      </button>

      <input type="text" id="searchInput" placeholder="üîé Search"
        class="w-full py-2 px-3 rounded-lg bg-gray-50 hover:bg-gray-200 placeholder-black focus:placeholder-gray-600 focus:outline-none">
    </div>

    <!-- div for shadow -->
    <div class="relative min-h-0 flex flex-grow overflow-hidden border-red-500">
      <div class="px-2 flex-grow overflow-y-scroll">
        <div class="pl-2 py-0 text-gray-300 select-none">Recent</div>
        <!-- sessionList here -->
        <div id="sessionList"></div>
        <div class="w-fit mx-auto text-2xl py-1">‚òÅÔ∏è</div>
      </div>
      <div class="absolute z-10 bottom-0 w-full h-2 bg-gradient-to-t from-gray-50 to-transparent pointer-events-none"></div>
    </div>
    <div class="mx-2 mb-1 flex">
      <select class="w-full py-2 px-2 rounded-lg bg-gray-50 hover:bg-gray-200 appearance-none flex">
        <option class="flex" value="none">üí° gemini-3-flash-preview</option>
      </select>
      <button id="settingsBtn" title="Settings" class="py-2 px-3 rounded-lg bg-gray-100 hover:bg-gray-200 flex" >‚öôÔ∏è</button>
    </div>
  </aside>

  <!-- main chat area -->
  <!-- anchor for the input bar -->
  <div class="text-lg flex-grow overflow-hidden flex relative">
    <!-- scroll area inside the anchor -->
    <div class="flex-grow overflow-y-scroll">
      <!-- do mx-auto -->
      <div id="chatHistory" class="max-w-6xl mx-auto px-6 md:px-10 lg:px-20 xl:px-28  pt-8 pb-[50vh]  flex flex-col gap-2">
        <!-- chatHistory here -->
      </div>
    </div>

    <!-- input bar -->
    <div class="max-w-6xl mx-auto px-6 md:px-10 lg:px-20 xl:px-28  absolute bottom-0 left-0 right-0 flex flex-col-reverse">
      <!-- The bottom gap is bg-white. Must be below the shadow of input bar -->
      <div class="pb-4 pt-0.5 bg-white"></div>
      <!-- The top half of the bar, especially the rounded corner, is transparent -->
      <div style="
        background: linear-gradient(
        to bottom, 
        transparent 50%, 
        white 50%
      );">
        <!-- The textarea. Simply bg-white. -->
        <div class="flex items-center border border-gray-300 rounded-3xl shadow-sm bg-white">
          <textarea id="userInput" class="min-w-0 flex-grow bg-transparent pl-5 py-3 resize-none outline-none" rows="1"
            placeholder="Ask me anything"></textarea>
          <!-- self-end keeps the button at the bottom when textarea grows -->
          <button id="runLlmButton"
            class="bg-gray-800 text-white w-9 h-9 rounded-full flex-shrink-0 m-2 self-end flex items-center justify-center transition">
            ‚Üë
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const modelName = 'google/gemini-3-flash-preview';
    let openai = null;  // dynamic import in the background, while we set up the page

    async function loadOpenAI() {
      const OpenAI = (await import('https://cdn.skypack.dev/openai@6.9.1')).default;
      openai = new OpenAI({
        baseURL: 'https://openrouter.ai/api/v1',
        apiKey: localStorage.getItem('api-key'),
        dangerouslyAllowBrowser: true
      });
      window.openai = openai;
    }
    loadOpenAI();

    // --- DOM Elements ---
    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const runLlmButton = document.getElementById('runLlmButton');

    const sessionList = document.getElementById('sessionList');
    const newChatBtn = document.getElementById('newChatBtn');
    const searchInput = document.getElementById('searchInput');
    const settingsBtn = document.getElementById('settingsBtn');

    let messages = [];
    let currentSessionId = null;
    let db = null;

    // Set Default Prompt
    // userInput.value = 'You are Gemini. Please write a 300-word resume about yourself.'

    // --- Markdown Setup ---
    const mdRenderer = window.markdownit({
      html: true,
      highlight: function (str, lang) {
        // console.log(str)
        // console.log(lang)
        if (lang && window.hljs.getLanguage(lang)) {
          try {
            return window.hljs.highlight(lang, str).value;
          } catch (e) {
            console.error(e);
          }
        }
        return ''; // use external default escaping
      }
    }).use(window.texmath, {
      engine: window.katex,
      delimiters: ['dollars', 'brackets', 'beg_end'],
      katexOptions: { macros: { "\\RR": "\\mathbb{R}" } }
    });

    function renderMarkdown(text) {
      let html = mdRenderer.render(text);
      // html = text;
      let dom = (new DOMParser()).parseFromString(html, 'text/html').body;
      // add copy buttons to pre
      dom.querySelectorAll('pre').forEach(pre => {
        const btn = document.createElement('button');
        btn.className = 'copy-btn absolute top-2 right-2 px-2 py-1 rounded-lg '
        btn.className += 'text-base bg-gray-100 text-gray-800 focus:outline-none ';
        btn.innerText = 'Copy';
        // mousedown is faster than click
        btn.onmousedown = () => {
          const text = pre.querySelector('code').innerText.trim();
          navigator.clipboard.writeText(text).then(() => {
            btn.innerText = 'Copied!';
            setTimeout(() => { btn.innerText = 'Copy'; }, 1000);
          });
        };
        pre.style.position = 'relative';
        pre.appendChild(btn);
      });
      return dom;
    }

    // --- IndexedDB Logic ---
    async function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('chat-db', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('sessions')) {
            db.createObjectStore('sessions', { keyPath: 'id' });
          }
        };
        request.onsuccess = (event) => {
          db = event.target.result;
          console.log(db)
          resolve(db);
        };
        request.onerror = (event) => reject(event.target.error);
      });
    }

    async function saveSessionToDB() {
      if (!db || messages.length === 0) return;

      if (!currentSessionId) {
        currentSessionId = Date.now().toString();
      }

      const firstUserMsg = messages.find(m => m.role === 'user');
      const maxTitleLength = 50;
      const rawTitle = firstUserMsg ? firstUserMsg.content : 'New Chat';
      const title = rawTitle.slice(0, maxTitleLength) + (rawTitle.length > maxTitleLength ? '...' : '');

      const session = {
        id: currentSessionId,
        updatedAt: Date.now(),
        title: title,
        messages: messages
      };

      return new Promise((resolve, reject) => {
        const tx = db.transaction('sessions', 'readwrite');
        const store = tx.objectStore('sessions');
        store.put(session);
        tx.oncomplete = () => {
          renderSidebar();
          resolve();
        };
        tx.onerror = () => reject(tx.error);
      });
    }

    async function loadAllSessions() {
      if (!db) return [];
      return new Promise((resolve) => {
        const tx = db.transaction('sessions', 'readonly');
        const store = tx.objectStore('sessions');
        const request = store.getAll();
        request.onsuccess = () => {
          const res = request.result.sort((a, b) => b.updatedAt - a.updatedAt);
          resolve(res);
        };
      });
    }

    async function loadSession(id) {
      return new Promise((resolve) => {
        const tx = db.transaction('sessions', 'readonly');
        const store = tx.objectStore('sessions');
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
      });
    }

    // --- settings ui logic ---
    settingsBtn.addEventListener('mousedown', () => {
      const apiKey = prompt('Enter your OpenRouter API Key:');
      if (apiKey !== null && apiKey.trim() !== '') {
        localStorage.setItem('api-key', apiKey);
        openai.apiKey = apiKey;
      }
    });

    // --- sidebar ui logic ---

    function clearChat() {
      chatHistory.innerHTML = '';
      messages = [];
      // userInput.value = '';
      // userInput.style.height = 'auto';
    }

    function appendMessage(role, content, isStreaming) {
      // auto-scroll is disabled by default
      // Check if user scrolled to bottom. If so we do auto-scroll after appending.
      // The scroll position is only accurate before we modify the DOM
      
      // const scrollBottom = chatHistory.scrollHeight - (chatHistory.scrollTop + chatHistory.clientHeight) < 10;
      const scrollBottom = false;

      let msgDiv;
      if (isStreaming) {
        msgDiv = document.getElementById('streaming-msg');
        if (!msgDiv) {
          const wrapper = document.createElement('div');
          wrapper.className = 'mb-4';
          msgDiv = document.createElement('div');
          msgDiv.id = 'streaming-msg';
          msgDiv.className = 'w-full max-w-none leading-relaxed prose';
          wrapper.appendChild(msgDiv);
          chatHistory.appendChild(wrapper);
        }
        msgDiv.replaceChildren(renderMarkdown(content))
      } else {
        console.log(role, content);
        const wrapper = document.createElement('div');
        wrapper.className = `flex w-full mb-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement('div');

        if (role === 'user') {
          bubble.className = 'bg-gray-100 px-4 py-2 rounded-2xl max-w-[80%] break-words whitespace-pre-wrap';
          bubble.innerText = content;
        } else {
          bubble.className = 'w-full max-w-none leading-relaxed prose';
          bubble.replaceChildren(renderMarkdown(content));
        }

        wrapper.appendChild(bubble);
        chatHistory.appendChild(wrapper);
      }

      if (scrollBottom) {
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }
    }

    async function switchToSession(id) {
      const session = await loadSession(id);
      if (!session) return;

      currentSessionId = session.id;
      clearChat();
      messages = session.messages || [];
      messages.forEach(msg => appendMessage(msg.role, msg.content, false));
      renderSidebar();
    }

    function createNewChat() {
      currentSessionId = null;
      clearChat();
      renderSidebar();
      userInput.focus();
    }

    async function renderSidebar() {
      const sessions = await loadAllSessions();
      sessionList.innerHTML = '';

      const filter = searchInput.value.toLowerCase();

      sessions.forEach(s => {
        if (filter && !s.title.toLowerCase().includes(filter)) return;

        const div = document.createElement('div');
        const isActive = s.id === currentSessionId;

        div.className = `p-2 rounded-lg cursor-pointer text-nowrap truncate select-none 
            ${isActive ? 'bg-gray-200' : 'hover:bg-gray-200'}`;
        div.innerText = s.title.replace(/\n/g, ' ') || 'New Chat';
        div.onmousedown = () => switchToSession(s.id);
        sessionList.appendChild(div);
      });

    }

    // --- chat ui logic ---

    newChatBtn.onmousedown = createNewChat;
    searchInput.addEventListener('input', renderSidebar);


    async function nextAnimationFrame() {
      return new Promise(resolve => {
        requestAnimationFrame(resolve);
      });
    }

    // if user is in some input method (eg. Chinese), don't treat Enter as submit
    let isComposing = false;
    userInput.addEventListener('compositionstart', function () {
      // console.log('composition start')
      isComposing = true;
    });
    userInput.addEventListener('compositionend', async function () {
      // console.log('composition end')
      await nextAnimationFrame();
      await nextAnimationFrame();
      isComposing = false;
    });

    userInput.addEventListener('keydown', function (e) {
      // call API if Enter is pressed, but not Shift+Enter
      // console.log(e, e.key, e.isComposing)
      if (e.key === 'Enter' && !e.shiftKey && !isComposing) {
        runLlm();
        e.preventDefault();  // don't insert newline
        // restore height to 1 line
        userInput.dispatchEvent(new Event('input'));
      }
    })

    userInput.addEventListener('submit', function (e) {
      console.log('submit event')
    })

    userInput.addEventListener('input', function (e) {
      // automatic textarea height
      userInput.style.height = 'auto';  // let the browser determine text height
      let height = userInput.scrollHeight;
      // console.log(height, window.innerHeight);
      height = Math.min(height, 0.6 * window.innerHeight);
      userInput.style.height = height + 'px';  // set new height
    });

    runLlmButton.onclick = runLlm;

    async function runLlm() {
      const text = userInput.value.trim();
      if (!text) return;

      userInput.value = '';
      appendMessage('user', text);
      messages.push({ role: 'user', content: text });
      console.log(messages);

      runLlmButton.disabled = true;
      runLlmButton.classList.add('opacity-50');

      let fullResponse = '';
      try {
        const stream = await openai.chat.completions.create({
          messages: messages,
          model: modelName,
          stream: true
        });

        for await (const chunk of stream) {
          const content = chunk.choices[0]?.delta?.content || '';
          console.log(content)
          fullResponse += content;
          appendMessage('assistant', fullResponse, true);
        }
      } catch (error) {
        fullResponse = `API Error: ${error.message}`;
        appendMessage('assistant', fullResponse, true);
        console.error("API Error:", error);
      }

      const streamingDiv = document.getElementById('streaming-msg');
      if (streamingDiv) streamingDiv.removeAttribute('id');

      messages.push({ role: 'assistant', content: fullResponse });
      runLlmButton.disabled = false;
      runLlmButton.classList.remove('opacity-50');

      await saveSessionToDB();
    }

    // --- Init ---
    (async () => {
      await initDB();
      await renderSidebar();

      if (currentSessionId === null) {
        // Initial state does not automatically clear, preserving the default value for demonstration
      }
    })();

  </script>
</body>

</html>
